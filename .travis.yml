---
dist: xenial
language: java
cache:
  directories:
  - $HOME/.m2
  - ~/.ansible/roles
  - ~/.terraform
  pip: true
  apt: true

before_script:
 - sudo apt-get update -q
 - sudo apt-get install -q python-pip 
 - pip install --upgrade --user ansible
 - ansible --version
 - ansible-galaxy install -r ansible/requirements.yml
 # Installs Packer and Terraform used in deployment steps
 - ansible-playbook -i localhost ansible/prepare_deploy_server.yml

install:
 - cd app && ./mvnw install -DskipTests=true -Dmaven.javadoc.skip=true -B -V

jobs:
 include:

#  - stage: test
#    name: Test App
#    before_script: skip # needs change
#    script: ./mvnw test -B

  - stage: deploy
    name: Build Golden Image AMI
    install: skip # maybe needs change  
    script: | 
      make bake
      #cat manifest.json
      AMIID=$(cat manifest.json | jq -r .builds[0].artifact_id |  cut -d':' -f2)
      make deploy AMIID=$AMIID

